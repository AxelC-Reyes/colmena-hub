<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COLMENA-HUB BETA</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body{ margin:0; background-color: #f3f4f6; }
    .logo-img { height: 100px; width: auto; transition: transform 0.3s ease; }
    .logo-img:hover { transform: scale(1.05); }
    .hexagon { clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>


<!-- En el HEAD, despu√©s de los estilos -->
<style>
  /* Estilos b√°sicos para Veriff */
  .veriff-status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
  }
  
  .veriff-pending {
    background: #FEF3C7;
    color: #92400E;
  }
  
  .veriff-success {
    background: #D1FAE5;
    color: #065F46;
  }
  
  .veriff-error {
    background: #FEE2E2;
    color: #991B1B;
  }
</style>

<!-- En el BODY, antes del cierre </body> -->
<script src="veriff-simple.js"></script>

<script>
  // ========== CONFIGURACI√ìN SIMPLIFICADA ==========
  
  // Variables globales
  let auth = null;
  let db = null;
  
  // Inicializar Firebase
  function initFirebase() {
    try {
      const firebaseConfig = {
        apiKey: "AIzaSyAeLIJ8ee9xUBduMKkijW4GdnY45W32Eew",
        authDomain: "colmena-hub.firebaseapp.com",
        projectId: "colmena-hub",
        storageBucket: "colmena-hub.firebasestorage.app",
        messagingSenderId: "806697924814",
        appId: "1:806697924814:web:b11c9b057bc6d1dd71789f",
        measurementId: "G-LQ9GLGJCX8"
      };
      
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      
      auth = firebase.auth();
      db = firebase.firestore();
      
      console.log('‚úÖ Firebase inicializado');
      return true;
    } catch (error) {
      console.error('‚ùå Error Firebase:', error);
      return false;
    }
  }
  
  // Manejar login Google
  document.getElementById('btnGoogle').addEventListener('click', async () => {
    if (!auth) {
      alert('Firebase no est√° listo. Recarga la p√°gina.');
      return;
    }
    
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      
      // Guardar en Firestore
      if (db) {
        await db.collection('users').doc(user.uid).set({
          uid: user.uid,
          displayName: user.displayName,
          email: user.email,
          photoURL: user.photoURL,
          lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          verified: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      }
      
      updateUI(user);
      alert(`¬°Bienvenido ${user.displayName}!`);
      
    } catch (error) {
      console.error('Error login:', error);
      alert('Error: ' + error.message);
    }
  });
  
  // Manejar logout
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    try {
      await auth.signOut();
      updateUI(null);
    } catch (error) {
      console.error('Error logout:', error);
    }
  });
  
  // Manejar verificaci√≥n Veriff
  document.getElementById('verify-btn')?.addEventListener('click', async () => {
    const user = auth?.currentUser;
    if (!user) {
      alert('Primero inicia sesi√≥n');
      return;
    }
    
    // Obtener datos del usuario
    const userData = {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName,
      firstName: user.displayName?.split(' ')[0] || 'Usuario',
      lastName: user.displayName?.split(' ').slice(1).join(' ') || 'Test'
    };
    
    // Iniciar Veriff
    if (window.VeriffSimple) {
      window.VeriffSimple.startVerification(userData);
    } else {
      alert('Veriff no est√° disponible. Recarga la p√°gina.');
    }
  });
  
  // Actualizar UI
  function updateUI(user) {
    const loginSection = document.getElementById('login-section');
    const userPanel = document.getElementById('user-panel');
    
    if (user) {
      loginSection.classList.add('hidden');
      userPanel.classList.remove('hidden');
      
      document.getElementById('user-name').textContent = user.displayName || 'Usuario';
      document.getElementById('user-email').textContent = user.email || '';
      
      const avatar = document.getElementById('user-avatar');
      if (avatar) {
        avatar.src = user.photoURL || 'https://ui-avatars.com/api/?name=' + 
          encodeURIComponent(user.displayName || 'Usuario') + '&background=FFD700&color=000';
      }
      
      // Mostrar estado de verificaci√≥n
      const verifiedBadge = document.getElementById('verified-badge');
      const verificationBadge = document.getElementById('verification-badge');
      
      if (user.verified) {
        verifiedBadge?.classList.remove('hidden');
        verificationBadge?.classList.add('hidden');
        document.getElementById('verify-btn')?.classList.add('hidden');
      } else {
        verificationBadge?.classList.remove('hidden');
        verifiedBadge?.classList.add('hidden');
        document.getElementById('verify-btn')?.classList.remove('hidden');
      }
      
    } else {
      loginSection.classList.remove('hidden');
      userPanel.classList.add('hidden');
    }
  }
  
  // Observador de autenticaci√≥n
  function setupAuthObserver() {
    if (!auth) return;
    
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        let userData = user;
        
        // Obtener datos de Firestore
        if (db) {
          try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
              userData = { ...user, ...userDoc.data() };
            }
          } catch (error) {
            console.warn('Error Firestore:', error);
          }
        }
        
        updateUI(userData);
      } else {
        updateUI(null);
      }
    });
  }
  
  // Inicializar
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ COLMENA HUB cargando...');
    
    // Inicializar Firebase
    if (initFirebase()) {
      setupAuthObserver();
    }
    
    // Verificar si estamos en local
    if (window.location.protocol === 'file:') {
      alert('‚ö†Ô∏è Ejecuta desde: http://localhost:8000');
    }
  });
</script>


<body class="min-h-screen bg-gray-50">
  <!-- Barra de estado superior -->
  <div id="status-bar" class="bg-yellow-500 text-white text-sm py-2 px-4 text-center hidden">
    <i class="fas fa-spinner fa-spin mr-2"></i>
    <span id="status-text">Cargando...</span>
  </div>

  <!-- Contenido principal -->
  <main class="container mx-auto px-4 py-12">
    
    <!-- Logo y T√≠tulo -->
    <div class="flex flex-col md:flex-row items-center justify-center gap-6 mb-10 fade-in">
      <img src="colmena-hubLOGO.png" alt="COLMENA HUB Logo" class="h-32 w-auto">
      <div class="text-center md:text-left">
        <h1 class="text-4xl font-bold text-gray-800">COLMENA-HUB BETA</h1>
        <p class="text-lg text-gray-600 mt-2">Prueba de integraci√≥n de APIs</p>
        <div class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded-lg hidden" id="local-warning">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          <strong>‚ö†Ô∏è NO FUNCIONAR√Å EN LOCAL:</strong> Usa un servidor (http://localhost:8000)
        </div>
      </div>
    </div>

    <!-- Panel de estado (solo visible cuando hay usuario) -->
    <div id="user-panel" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6 mb-8 hidden fade-in">
      <div class="flex items-center space-x-4">
        <img id="user-avatar" src="" alt="Avatar" class="w-16 h-16 rounded-full border-2 border-yellow-500">
        <div>
          <h2 id="user-name" class="text-xl font-bold text-gray-800"></h2>
          <p id="user-email" class="text-gray-600 text-sm"></p>
          <div class="flex items-center mt-2">
            <span id="verification-badge" class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium hidden">
              <i class="fas fa-times-circle mr-1"></i> No verificado
            </span>
            <span id="verified-badge" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium hidden">
              <i class="fas fa-check-circle mr-1"></i> Verificado
            </span>
          </div>
        </div>
      </div>
      <div class="mt-6 grid grid-cols-2 gap-4">
        <button id="logout-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition flex items-center justify-center">
          <i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesi√≥n
        </button>
        <button id="verify-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
          <i class="fas fa-shield-alt mr-2"></i> Verificar
        </button>
      </div>
    </div>

    <!-- Hex√°gonos principales -->
    <div class="flex flex-col md:flex-row items-center justify-center gap-12 mb-12 fade-in">
      <a href="professional-type.html"
         class="relative w-56 h-60 flex flex-col items-center justify-center text-white font-bold text-xl
                bg-gradient-to-br from-yellow-500 to-yellow-600 shadow-lg hover:from-yellow-600 hover:to-yellow-700 
                transition-all duration-300 hexagon transform hover:-translate-y-2">
        <i class="fas fa-search text-3xl mb-2"></i>
        <span>CONTRATAR</span>
        <p class="text-sm font-normal mt-2 text-center px-4">Buscar profesionales</p>
      </a>

      <a href="apply-simple.html"
         class="relative w-56 h-60 flex flex-col items-center justify-center text-white font-bold text-xl
                bg-gradient-to-br from-yellow-500 to-yellow-600 shadow-lg hover:from-yellow-600 hover:to-yellow-700 
                transition-all duration-300 hexagon transform hover:-translate-y-2">
        <i class="fas fa-user-check text-3xl mb-2"></i>
        <span>SER CONTRATADO</span>
        <p class="text-sm font-normal mt-2 text-center px-4">Registro simplificado</p>
      </a>
    </div>

    <!-- Bot√≥n de login (visible cuando NO hay usuario) -->
    <div id="login-section" class="text-center fade-in">
      <p class="text-gray-600 mb-4">Inicia sesi√≥n para comenzar</p>
      <button id="btnGoogle" class="px-6 py-3 bg-white text-gray-700 rounded-lg border border-gray-300 
                                    hover:bg-gray-50 transition inline-flex items-center justify-center gap-3 
                                    shadow hover:shadow-md transform hover:-translate-y-1">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" 
             class="w-5 h-5" 
             alt="Google">
        <span class="font-medium">Ingresar con Google</span>
      </button>
      <p class="text-xs text-gray-500 mt-3">
        <i class="fas fa-info-circle mr-1"></i>
        Necesitas ejecutar desde <code>http://localhost:8000</code>
      </p>
    </div>

    <!-- Panel de debug (solo para pruebas) -->
    <div class="max-w-2xl mx-auto mt-12 bg-gray-100 rounded-lg p-6 border border-gray-300 fade-in">
      <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-vial mr-2 text-yellow-600"></i> Panel de pruebas BETA
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <button id="test-firestore" class="px-4 py-3 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 
                                           transition flex items-center justify-center">
          <i class="fas fa-database mr-2"></i> Probar Firestore
        </button>
        <button id="test-auth" class="px-4 py-3 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 
                                      transition flex items-center justify-center">
          <i class="fas fa-user-check mr-2"></i> Probar Auth
        </button>
        <button id="test-veriff" class="px-4 py-3 bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200 
                                        transition flex items-center justify-center">
          <i class="fas fa-shield-alt mr-2"></i> Probar Veriff
        </button>
      </div>
      <div id="test-results" class="text-sm text-gray-600"></div>
      
      <!-- Instrucciones para servidor local -->
      <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <h4 class="font-bold text-yellow-800 mb-2 flex items-center">
          <i class="fas fa-server mr-2"></i> ¬øNo funciona el login?
        </h4>
        <p class="text-yellow-700 text-sm mb-2">Ejecuta en terminal:</p>
        <div class="bg-black text-green-400 p-3 rounded font-mono text-xs">
          <div class="mb-1"># Opci√≥n 1 (Python 3)</div>
          <div class="text-yellow-300">python3 -m http.server 8000</div>
          <div class="mb-1 mt-2"># Opci√≥n 2 (Node.js)</div>
          <div class="text-yellow-300">npx http-server -p 8000</div>
        </div>
        <p class="text-yellow-700 text-xs mt-2">Luego abre: <a href="http://localhost:8000" class="underline">http://localhost:8000</a></p>
      </div>
    </div>
  </main>

  <!-- Footer simplificado -->
  <footer class="mt-16 py-6 bg-gray-800 text-white">
    <div class="container mx-auto px-4 text-center">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
          <div class="flex items-center justify-center md:justify-start space-x-2">
            <i class="fas fa-bee text-yellow-400"></i>
            <span class="font-bold text-lg">COLMENA HUB BETA v0.1</span>
          </div>
          <p class="text-gray-400 text-sm mt-1">Pruebas de integraci√≥n t√©cnica</p>
        </div>
        <div class="text-sm text-gray-400">
          <p class="flex flex-wrap justify-center gap-2">
            <span class="px-2 py-1 bg-gray-700 rounded">Firebase ‚úì</span>
            <span class="px-2 py-1 bg-gray-700 rounded">OAuth ‚úì</span>
            <span class="px-2 py-1 bg-gray-700 rounded">Veriff ‚úì</span>
            <span class="px-2 py-1 bg-gray-700 rounded">Stripe (pr√≥ximo)</span>
          </p>
        </div>
      </div>
    </div>
  </footer>

  <!-- ========== SCRIPTS EN ORDEN CORRECTO ========== -->
  
  <!-- 1. Firebase SDK (SIEMPRE PRIMERO) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- 2. Veriff SDK (OPCIONAL - puede fallar pero no debe bloquear OAuth) -->
  <script>
    // Cargar Veriff solo si existe el archivo
    function loadVeriff() {
      const script = document.createElement('script');
      script.src = 'veriff-real.js';
      script.onerror = function() {
        console.log('‚ö†Ô∏è veriff-real.js no encontrado, usando simulaci√≥n');
        window.VeriffReal = {
          startVeriffVerification: simulateVeriff,
          config: { SIMULATION_MODE: true }
        };
      };
      document.head.appendChild(script);
    }
    
    function simulateVeriff(userData, onSuccess, onError) {
      console.log('üé≠ Simulando Veriff para:', userData.email);
      setTimeout(() => {
        if (onSuccess) {
          onSuccess({
            id: 'simulated_' + Date.now(),
            status: 'approved',
            person: userData
          });
        }
      }, 1500);
      return 'simulated_session';
    }
    
    // Cargar Veriff despu√©s de que todo est√© listo
    window.addEventListener('DOMContentLoaded', loadVeriff);
  </script>
  
  <!-- 3. C√≥digo principal de la aplicaci√≥n -->
  <script>
    // ========== CONFIGURACI√ìN FIREBASE ==========
    
    const firebaseConfig = {
      apiKey: "AIzaSyAeLIJ8ee9xUBduMKkijW4GdnY45W32Eew",
      authDomain: "colmena-hub.firebaseapp.com",
      projectId: "colmena-hub",
      storageBucket: "colmena-hub.firebasestorage.app",
      messagingSenderId: "806697924814",
      appId: "1:806697924814:web:b11c9b057bc6d1dd71789f",
      measurementId: "G-LQ9GLGJCX8"
    };
    
    // Variables globales
    let auth = null;
    let db = null;
    let firebaseInitialized = false;
    
    // ========== FUNCIONES GLOBALES ==========
    
    function showStatus(message, isError = false) {
      const bar = document.getElementById('status-bar');
      const text = document.getElementById('status-text');
      
      if (isError) {
        bar.className = 'bg-red-500 text-white text-sm py-2 px-4 text-center';
        bar.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i><span>${message}</span>`;
      } else {
        bar.className = 'bg-yellow-500 text-white text-sm py-2 px-4 text-center';
        bar.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i><span>${message}</span>`;
      }
      
      bar.classList.remove('hidden');
      
      if (!isError) {
        setTimeout(() => bar.classList.add('hidden'), 3000);
      }
    }
    
    function updateUI(userData) {
      const loginSection = document.getElementById('login-section');
      const userPanel = document.getElementById('user-panel');
      
      if (!loginSection || !userPanel) {
        console.log('‚è≥ Elementos UI a√∫n no disponibles');
        return;
      }
      
      if (userData) {
        loginSection.classList.add('hidden');
        userPanel.classList.remove('hidden');
        
        document.getElementById('user-name').textContent = userData.displayName || 'Usuario';
        document.getElementById('user-email').textContent = userData.email || '';
        
        const avatar = document.getElementById('user-avatar');
        if (avatar) {
          avatar.src = userData.photoURL || 'https://ui-avatars.com/api/?name=' + 
            encodeURIComponent(userData.displayName || 'Usuario') + '&background=FFD700&color=000';
        }
        
        const verifiedBadge = document.getElementById('verified-badge');
        const verificationBadge = document.getElementById('verification-badge');
        const verifyBtn = document.getElementById('verify-btn');
        
        if (verifiedBadge && verificationBadge && verifyBtn) {
          if (userData.verified) {
            verifiedBadge.classList.remove('hidden');
            verificationBadge.classList.add('hidden');
            verifyBtn.classList.add('hidden');
          } else {
            verificationBadge.classList.remove('hidden');
            verifiedBadge.classList.add('hidden');
            verifyBtn.classList.remove('hidden');
          }
        }
        
      } else {
        loginSection.classList.remove('hidden');
        userPanel.classList.add('hidden');
      }
    }
    
    // ========== INICIALIZACI√ìN FIREBASE ==========
    
    function initializeFirebase() {
      try {
        console.log('üî• Intentando inicializar Firebase...');
        
        // Verificar si estamos en local (file://)
        if (window.location.protocol === 'file:') {
          const warning = document.getElementById('local-warning');
          if (warning) warning.classList.remove('hidden');
          showStatus('‚ö†Ô∏è Ejecuta desde localhost:8000', true);
          return false;
        }
        
        // Inicializar Firebase solo si no existe
        if (!firebase.apps.length) {
          console.log('üî• Firebase no inicializado, inicializando...');
          firebase.initializeApp(firebaseConfig);
          console.log('‚úÖ Firebase inicializado correctamente');
        } else {
          console.log('üî• Firebase ya estaba inicializado');
        }
        
        // Obtener referencias
        auth = firebase.auth();
        db = firebase.firestore();
        firebaseInitialized = true;
        
        console.log('‚úÖ Firebase Auth y Firestore listos');
        return true;
        
      } catch (error) {
        console.error('‚ùå Error FATAL inicializando Firebase:', error);
        showStatus('Error cr√≠tico Firebase: ' + error.message, true);
        return false;
      }
    }
    
    // ========== MANEJO DE AUTENTICACI√ìN ==========
    
    function setupAuthListeners() {
      console.log('üîß Configurando listeners de autenticaci√≥n...');
      
      const btnGoogle = document.getElementById('btnGoogle');
      const logoutBtn = document.getElementById('logout-btn');
      
      if (btnGoogle) {
        console.log('‚úÖ Bot√≥n Google encontrado, agregando listener');
        btnGoogle.addEventListener('click', handleGoogleLogin);
      } else {
        console.error('‚ùå Bot√≥n Google NO encontrado');
      }
      
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }
    }
    
    async function handleGoogleLogin() {
      console.log('üü° Bot√≥n Google clickeado');
      
      if (!firebaseInitialized || !auth) {
        showStatus('Error: Firebase no est√° listo. Recarga la p√°gina.', true);
        console.error('‚ùå Firebase no inicializado al hacer click');
        return;
      }
      
      showStatus('Iniciando sesi√≥n con Google...');
      console.log('üîÑ Iniciando proceso OAuth...');
      
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        
        console.log('üîÑ Llamando signInWithPopup...');
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        console.log('‚úÖ Login exitoso:', user.email);
        
        // Intentar guardar en Firestore (opcional)
        if (db) {
          try {
            await db.collection('users').doc(user.uid).set({
              uid: user.uid,
              displayName: user.displayName,
              email: user.email,
              photoURL: user.photoURL,
              lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
              verified: false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            console.log('‚úÖ Usuario guardado en Firestore');
          } catch (firestoreError) {
            console.warn('‚ö†Ô∏è Error Firestore (permisos?):', firestoreError);
          }
        }
        
        showStatus(`¬°Bienvenido ${user.displayName}!`);
        console.log('‚úÖ UI actualizada');
        
      } catch (error) {
        console.error('‚ùå Error en login Google:', error);
        
        if (error.code === 'auth/operation-not-supported-in-this-environment') {
          showStatus('‚ö†Ô∏è Ejecuta desde http://localhost:8000', true);
          const warning = document.getElementById('local-warning');
          if (warning) warning.classList.remove('hidden');
        } else if (error.code === 'auth/popup-blocked') {
          showStatus('‚ö†Ô∏è Ventana emergente bloqueada. Permite popups.', true);
        } else if (error.code === 'auth/popup-closed-by-user') {
          showStatus('Ventana cerrada por el usuario', false);
        } else {
          showStatus(`Error: ${error.message}`, true);
        }
      }
    }
    
    async function handleLogout() {
      try {
        await auth.signOut();
        showStatus('Sesi√≥n cerrada correctamente');
      } catch (error) {
        showStatus(`Error: ${error.message}`, true);
      }
    }
    
    // ========== VERIFICACI√ìN VERIFF ==========
    
    function setupVeriffButton() {
      const verifyBtn = document.getElementById('verify-btn');
      if (!verifyBtn) {
        console.warn('‚ö†Ô∏è Bot√≥n verify-btn no encontrado');
        return;
      }
      
      verifyBtn.addEventListener('click', handleVerification);
    }
    
    async function handleVerification() {
      const user = auth?.currentUser;
      if (!user) {
        showStatus('Primero inicia sesi√≥n', true);
        return;
      }
      
      showStatus('Iniciando verificaci√≥n de identidad...');
      
      // Verificar si Veriff est√° disponible
      if (window.VeriffReal && window.VeriffReal.startVeriffVerification) {
        try {
          const userData = {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            firstName: user.displayName?.split(' ')[0] || 'Usuario',
            lastName: user.displayName?.split(' ').slice(1).join(' ') || 'Test'
          };
          
          console.log('üöÄ Llamando Veriff Real...');
          const sessionId = await window.VeriffReal.startVeriffVerification(
            userData,
            async (verificationData) => {
              console.log('‚úÖ Veriff √©xito:', verificationData);
              
              try {
                if (db) {
                  await db.collection('users').doc(user.uid).update({
                    verified: true,
                    veriffId: verificationData.id,
                    veriffStatus: verificationData.status,
                    verificationDate: firebase.firestore.FieldValue.serverTimestamp()
                  });
                }
                
                showStatus('‚úÖ ¬°Identidad verificada exitosamente!');
                
                // Recargar UI
                const userDoc = db ? await db.collection('users').doc(user.uid).get() : null;
                updateUI({ 
                  ...user, 
                  ...(userDoc?.exists ? userDoc.data() : {}) 
                });
                
              } catch (error) {
                console.error('Error guardando verificaci√≥n:', error);
                showStatus('‚úÖ Verificado (error guardando datos)', false);
              }
            },
            (error) => {
              console.error('‚ùå Error Veriff:', error);
              showStatus('Error en verificaci√≥n: ' + error.message, true);
            }
          );
          
          if (sessionId) {
            showStatus('Redirigiendo a Veriff...');
          }
          
        } catch (error) {
          console.error('Error iniciando Veriff:', error);
          simulateVeriffFallback(user);
        }
      } else {
        // Veriff no disponible, usar simulaci√≥n
        simulateVeriffFallback(user);
      }
    }
    
    async function simulateVeriffFallback(user) {
      showStatus('‚ö†Ô∏è Usando simulaci√≥n...');
      
      setTimeout(async () => {
        try {
          if (db) {
            await db.collection('users').doc(user.uid).update({
              verified: true,
              verifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
              verificationMethod: 'simulated'
            });
          }
          
          showStatus('‚úÖ ¬°Identidad verificada exitosamente! (simulaci√≥n)');
          
          if (db) {
            const userDoc = await db.collection('users').doc(user.uid).get();
            updateUI({ ...user, ...userDoc.data() });
          } else {
            updateUI({ ...user, verified: true });
          }
          
        } catch (error) {
          console.error('Error en simulaci√≥n:', error);
          showStatus('Error: ' + error.message, true);
        }
      }, 2000);
    }
    
    // ========== PRUEBAS T√âCNICAS ==========
    
    function setupTestButtons() {
      const testFirestore = document.getElementById('test-firestore');
      const testAuth = document.getElementById('test-auth');
      const testVeriff = document.getElementById('test-veriff');
      
      if (testFirestore) {
        testFirestore.addEventListener('click', testFirestoreConnection);
      }
      
      if (testAuth) {
        testAuth.addEventListener('click', testAuthConnection);
      }
      
      if (testVeriff) {
        testVeriff.addEventListener('click', testVeriffSimulation);
      }
    }
    
    async function testFirestoreConnection() {
      if (!firebaseInitialized) {
        showTestResult('Firestore: NO INICIALIZADO', false);
        return;
      }
      
      showStatus('Probando Firestore...');
      
      try {
        const testRef = db.collection('test').doc('connection');
        await testRef.set({
          test: 'OK',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          url: window.location.href
        });
        
        const doc = await testRef.get();
        showTestResult(`Firestore: CONECTADO ‚úì<br>ID: ${doc.id}<br>URL: ${doc.data().url}`, true);
        showStatus('Firestore: Conexi√≥n exitosa');
        
      } catch (error) {
        showTestResult(`Firestore: ERROR<br>${error.message}<br><small>Revisa reglas de seguridad</small>`, false);
        showStatus('Firestore: Error de conexi√≥n', true);
      }
    }
    
    function testAuthConnection() {
      if (!firebaseInitialized) {
        showTestResult('Auth: NO INICIALIZADO', false);
        return;
      }
      
      const user = auth.currentUser;
      if (!user) {
        showTestResult('Auth: NO AUTENTICADO<br>Inicia sesi√≥n primero', false);
        return;
      }
      
      showTestResult(`Auth: AUTENTICADO ‚úì<br>Usuario: ${user.email}<br>UID: ${user.uid.substring(0, 10)}...`, true);
      showStatus('Auth: Usuario verificado');
    }
    
    function testVeriffSimulation() {
      const user = auth?.currentUser;
      if (!user) {
        showTestResult('Veriff: NO AUTENTICADO', false);
        return;
      }
      
      if (window.VeriffReal && window.VeriffReal.config) {
        const hasApiKey = window.VeriffReal.config.API_KEY && 
                         window.VeriffReal.config.API_KEY !== '6a4c5b3d-8e9f-4a7b-9c8d-1e2f3a4b5c6d';
        
        showTestResult(
          `Veriff: ${hasApiKey ? 'CONFIGURADO ‚úì' : 'SIMULACI√ìN'} <br>` +
          `Usuario: ${user.email}<br>` +
          `<small>${hasApiKey ? 'API Key presente' : 'Configura API Key para Veriff real'}</small>`, 
          true
        );
      } else {
        showTestResult('Veriff: SIMULACI√ìN DISPONIBLE ‚úì<br>Usuario: ' + user.email, true);
      }
      showStatus('Veriff: Simulaci√≥n disponible');
    }
    
    function showTestResult(message, isSuccess) {
      const resultsDiv = document.getElementById('test-results');
      if (!resultsDiv) return;
      
      const colorClass = isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
      const icon = isSuccess ? 'fa-check-circle' : 'fa-times-circle';
      const iconColor = isSuccess ? 'text-green-600' : 'text-red-600';
      
      resultsDiv.innerHTML = `
        <div class="${colorClass} p-3 rounded-lg mt-2 fade-in">
          <i class="fas ${icon} ${iconColor} mr-2"></i>
          ${message}
        </div>
      `;
    }
    
    // ========== OBSERVADOR DE AUTENTICACI√ìN ==========
    
    function setupAuthObserver() {
      if (!auth) {
        console.error('‚ùå Auth no disponible para observer');
        return;
      }
      
      console.log('üëÅÔ∏è Configurando observer de autenticaci√≥n...');
      
      auth.onAuthStateChanged(async (user) => {
        console.log('üîÑ Estado de autenticaci√≥n cambiado:', user ? user.email : 'NO USER');
        
        if (user) {
          try {
            let userData = user;
            
            // Intentar obtener datos de Firestore
            if (db) {
              try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                  userData = { ...user, ...userDoc.data() };
                  console.log('‚úÖ Datos de Firestore obtenidos');
                } else {
                  console.log('‚ö†Ô∏è Usuario no encontrado en Firestore');
                }
              } catch (firestoreError) {
                console.warn('‚ö†Ô∏è Error obteniendo usuario de Firestore:', firestoreError);
              }
            }
            
            updateUI(userData);
            
          } catch (error) {
            console.error("Error obteniendo usuario:", error);
            updateUI(user);
          }
        } else {
          updateUI(null);
        }
      });
    }
    
    // ========== INICIALIZACI√ìN DE LA P√ÅGINA ==========
    
    function initializePage() {
      console.log('üöÄ COLMENA HUB BETA v0.1 - Inicializando p√°gina...');
      
      // 1. Inicializar Firebase
      if (initializeFirebase()) {
        showStatus('Sistema BETA listo. Inicia sesi√≥n para comenzar.');
        
        // 2. Configurar listeners DESPU√âS de Firebase
        setupAuthListeners();
        setupVeriffButton();
        setupTestButtons();
        setupAuthObserver();
        
        console.log('‚úÖ P√°gina inicializada correctamente');
      } else {
        console.error('‚ùå Fall√≥ la inicializaci√≥n de Firebase');
      }
      
      // 3. Detectar si estamos en local
      if (window.location.protocol === 'file:') {
        const warning = document.getElementById('local-warning');
        if (warning) warning.classList.remove('hidden');
        
        // Deshabilitar botones que requieren Firebase
        const btnGoogle = document.getElementById('btnGoogle');
        if (btnGoogle) {
          btnGoogle.disabled = true;
          btnGoogle.innerHTML = '<i class="fas fa-ban mr-2"></i><span>Ejecuta desde localhost</span>';
          btnGoogle.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
    }
    
    // Esperar a que el DOM est√© completamente cargado
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializePage);
    } else {
      // DOM ya cargado
      initializePage();
    }
    
    // Log inicial
    console.log('üìÑ P√°gina cargada, estado:', document.readyState);
  </script>
</body>
</html>








